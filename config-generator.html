<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<title>Miscord Config Generator</title>
		<link rel="icon" href="img/icon.png">
		<link rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css"
			integrity="sha256-zIG416V1ynj3Wgju/scU80KAEWOsO5rRLfVyRDuOv7Q="
			crossorigin="anonymous" />
		<link rel="stylesheet" href="style.css">
		<link rel="stylesheet" href="checkbox.css">
		<style>
			.input::-moz-placeholder,
			.textarea::-moz-placeholder {
				color: rgba(54, 54, 54, 0.7);
			}

			.input::-webkit-input-placeholder,
			.textarea::-webkit-input-placeholder {
				color: rgba(54, 54, 54, 0.7);
			}

			.input:-moz-placeholder,
			.textarea:-moz-placeholder {
				color: rgba(54, 54, 54, 0.7);
			}

			.input:-ms-input-placeholder,
			.textarea:-ms-input-placeholder {
				color: rgba(54, 54, 54, 0.7);
			}
		</style>
		<style>
			.config::before {
				background: #209cee;
				border-radius: 2px 2px 0 0;
				bottom: 98%;
				color: rgba(0,0,0,.7);
				content: "Config";
				display: inline-block;
				font-size: 10px;
				font-weight: 700;
				/* left: 5px; */
				letter-spacing: 1px;
				margin-left: -1px;
				padding: 3px 5px;
				position: absolute;
				text-transform: uppercase;
				vertical-align: top;
			}

			#config-miscord::before {
				content: "Miscord";
			}

			#config-messenger::before {
				content: "Messenger";
			}

			#config-discord::before {
				content: "Discord";
			}

			.config {
				margin-bottom: 2rem !important;
			}
		</style>
	</head>
	<body>
		<section class="hero is-info">
			<div class="hero-body">
				<div class="container">
					<h1 class="title">
						Miscord Config Generator
					</h1>
				</div>
			</div>
		</section>

		<section class="section">

			<div class="container" style="margin-bottom: 2rem;">
				<div class="file is-info" id="upload-wrapper">
					<label class="file-label">
						<input class="file-input" type="file" id="config-upload">
						<span class="file-cta">
							<span class="file-label">
								Upload your config fileâ€¦
							</span>
						</span>
						<span class="file-name" id="filename" style="visibility: hidden"></span>
					</label>
				</div>
			</div>

			<div class="container">
				<div class="columns">
					<div class="column">
						<div class="box config" id="config-miscord">
							<div class="field">
								<label class="label">Log level</label>
								<div class="select">
									<select id="miscord-logLevel">
										<option value="silent">silent</option>
										<option value="warn">warn</option>
										<option value="info" selected>info</option>
										<option value="verbose">verbose</option>
										<option value="silly">silly</option>
									</select>
								</div>
							</div>
				
							<div class="field">
								<label class="checkbox">
									<input id="miscord-checkUpdates" type="checkbox" checked="checked">
									<span>Check updates</span>
								</label>
							</div>
			
							<div class="field">
								<textarea id="miscord-custom" class="textarea" placeholder="Custom mapping in the format &quot;threadID:Discord channel name/ID&quot; (one in a line) "></textarea>
							</div>
						</div>
					</div>
					<div class="column">
						<div class="box config" id="config-messenger">
							<div class="field">
								<input class="input" id="messenger-username" type="text" placeholder="Facebook mail/username">
							</div>
			
							<div class="field">
								<input class="input" id="messenger-password" type="text" placeholder="Facebook password">
							</div>
			
							<div class="field">
								<label class="checkbox">
									<input id="messenger-forceLogin" type="checkbox">
									<span>Force login to Facebook (skip login reviews, etc.)</span>
								</label>
							</div>
			
							<div class="field">
								<label class="label">White/blacklist</label>
								<div class="select">
									<select id="messenger-list-type">
										<option value="whitelist">Whitelist</option>
										<option value="blacklist">Blacklist</option>
									</select>
								</div>
								<textarea id="messenger-filter" class="textarea" placeholder="Facebook thread IDs (one in a line)"></textarea>
							</div>
			
							<div class="field">
								<input class="input" id="messenger-format" type="text" placeholder="Message format">
							</div>
			
							<div class="field">
								<input class="input" id="messenger-sourceFormat-discord" type="text" placeholder="Discord source format (if you used {source})">
							</div>
			
							<div class="field">
								<input class="input" id="messenger-sourceFormat-messenger" type="text" placeholder="Messenger source format (if you used {source})">
							</div>
			
							<div class="field">
								<textarea id="messenger-link" class="textarea" placeholder="Facebook chat linking (thread IDs separated by a colon, one link in a line)"></textarea>
							</div>
			
							<div class="field">
								<label class="checkbox">
									<input id="messenger-ignoreEmbeds" type="checkbox">
									<span>Ignore embeds from Discord</span>
								</label>
							</div>
						</div>
					</div>
					<div class="column">
						<div class="box config" id="config-discord">
							<div class="field">
								<input class="input" id="discord-token" type="text" placeholder="Discord token">
							</div>
			
							<div class="field">
								<input class="input" id="discord-guild" type="text" placeholder="Discord guild (leave empty for the first guild available)">
							</div>
							
							<div class="field">
								<input class="input" id="discord-category" type="text" placeholder="Discord category name (default: messenger)">
							</div>
			
							<div class="field">
								<label class="checkbox">
									<input id="discord-renameChannels" type="checkbox" checked="checked">
									<span>Rename Discord channels according to Messenger chat renames</span>
								</label>
							</div>
			
							<div class="field">
								<label class="checkbox">
									<input id="discord-showEvents" type="checkbox">
									<span>Show Messenger chat events (kick/leave/chat rename, etc.) on Discord</span>
								</label>
							</div>
			
							<div class="field">
								<label class="checkbox">
									<input id="discord-showFullNames" type="checkbox">
									<span>Show Messenger users' full names alongside their nicknames on Discord</span>
								</label>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="container">
				<div class="level">
					<div class="level-left">
						<a class="button is-info is-medium" id="generate-config">Generate config</a>
					</div>
					<div class="level-right">
						<a class="button is-info is-medium" id="download-config">Download config</a>
					</div>
				</div> 
				<div class="field">
					<textarea class="textarea" placeholder="Click the button above" id="output" rows="25"></textarea>
				</div> 
			</div>

		</section>

		<footer class="footer hero is-info is-paddingless">
			<div class="hero-body">
				<div class="container">
					<div class="has-text-centered">
						<p>Created by <a href="https://bjorn.ml">Bjornskjald</a>.</p>
						<p class="disclaimer"><strong>Miscord</strong> is a third-party app and is not affiliated with Facebook nor Discord.</p>
						<div class="block">
							<a class="button is-info is-inverted is-outlined" href="https://github.com/Bjornskjald/miscord">Source Code</a>
						</div>
					</div>
				</div>
			</div>
		</footer>

		<script>
			// CONSTANTS
			const getElement = e => document.querySelector(e)
			const v = (value, defaultValue) => value === defaultValue ? undefined : value
			const style = {
				setDanger: el => { el.classList.remove('is-info'); el.classList.add('is-danger') },
				setInfo: el => { el.classList.remove('is-danger'); el.classList.add('is-info') }
			}
			const form = {
				get logLevel() { return getElement('#miscord-logLevel').value },
				set logLevel(val) { getElement('#miscord-logLevel').value = val },

				get checkUpdates() { return getElement('#miscord-checkUpdates').checked },
				set checkUpdates(val) { getElement('#miscord-checkUpdates').checked = val },

				get custom() { return getElement('#miscord-custom').value },
				set custom(val) { getElement('#miscord-custom').value = handle.custom(val) }, 

				messenger: {
					get username () { return getElement('#messenger-username').value },
					set username(val) { getElement('#messenger-username').value = val },

					get password() { return getElement('#messenger-password').value },
					set password(val) { getElement('#messenger-password').value = val },

					get forceLogin() { return getElement('#messenger-forceLogin').checked },
					set forceLogin(val) { getElement('#messenger-forceLogin').checked = val },

					get filter() { return getElement('#messenger-filter').value },
					set filter(val) { getElement('#messenger-filter').value = handle.filter(val) },

					get format() { return getElement('#messenger-format').value },
					set format(val) { getElement('#messenger-format').value = val },

					get sourceFormat() { return {
						discord: getElement('#messenger-sourceFormat-discord').value,
						messenger: getElement('#messenger-sourceFormat-messenger').value
					}},
					set sourceFormat(val) {
						getElement('#messenger-sourceFormat-discord').value = val.discord
						getElement('#messenger-sourceFormat-messenger').value = val.messenger
					},

					get link() { return getElement('#messenger-link').value },
					set link(val) { getElement('#messenger-link').value = handle.link(val) },

					get ignoreEmbeds() { return getElement('#messenger-ignoreEmbeds').value },
					set ignoreEmbeds(val) { getElement('#messenger-ignoreEmbeds').value = val },
				},

				discord: {
					get token() { return getElement('#discord-token').value },
					set token(val) { getElement('#discord-token').value = val },

					get guild() { return getElement('#discord-guild').value },
					set guild(val) { getElement('#discord-guild').value = val },

					get category() { return getElement('#discord-category').value },
					set category(val) { getElement('#discord-category').value = val },

					get renameChannels() { return getElement('#discord-renameChannels').checked },
					set renameChannels(val) { getElement('#discord-renameChannels').checked = val },

					get showEvents() { return getElement('#discord-showEvents').checked },
					set showEvents(val) { getElement('#discord-showEvents').checked = val },

					get showFullNames() { return getElement('#discord-showFullNames').checked },
					set showFullNames(val) { getElement('#discord-showFullNames').checked = val }
				}
			}

			// ELEMENTS
			var upload = getElement('#config-upload')
			var uploadWrapper = getElement('#upload-wrapper')


			// BUTTONS
			getElement('#generate-config').addEventListener('click', e => { getElement('#output').innerHTML = generateConfig() })
			getElement('#download-config').addEventListener('click', e => downloadData(generateConfig(), 'config.json'))

			upload.addEventListener('change', e => {
				if (upload.files.length === 0) return
				var file = upload.files[0]

				style.setInfo(uploadWrapper)
				uploadWrapper.classList.add('has-name')

				var filename = getElement('#filename')
				filename.style.visibility = 'visible'
				filename.innerHTML = file.name

				if (!file.name.endsWith('.json')) return style.setDanger(uploadWrapper)
				
				var reader = new FileReader()
				reader.readAsText(file)
				reader.addEventListener('load', ev => {
					var content = ev.target.result
					if (!content || !content.length) return
					try {
						return handleUpload(JSON.parse(content))
					} catch (err) {
						console.error(err)
						return style.setDanger(uploadWrapper)
					}
				})
			})

			function handleUpload (config) {
				for (var key in config) {
					if (key === 'messenger' || key === 'discord') {
						for (let vkey in config[key]) form[key][vkey] = config[key][vkey]
					} else form[key] = config[key]
				}
			}
			function generateConfig () {
				if (!form.messenger.username) return alert('Messenger username missing!') || ''
				if (!form.messenger.password) return alert('Messenger password missing!') || ''
				if (!form.discord.token) return alert('Discord token missing!') || ''

				var config = {
					logLevel: v(form.logLevel, 'info'),
					checkUpdates: v(form.checkUpdates, true),
					custom: parse.custom(form.custom),
					messenger: {
						username: form.messenger.username,
						password: form.messenger.password,
						forceLogin: v(form.messenger.forceLogin, false),
						filter: parse.filter(form.messenger.filter),
						format: v(form.messenger.format, ''),
						sourceFormat: parse.sourceFormat(form.messenger.sourceFormat),
						link: parse.link(form.messenger.link)
					},
					discord: {
						token: form.discord.token,
						guild: v(form.discord.guild, ''),
						category: v(form.discord.category, ''),
						renameChannels: v(form.discord.renameChannels, true),
						showEvents: v(form.discord.showEvents, false),
						showFullNames: v(form.discord.showFullNames, false)
					}
				}

				return JSON.stringify(config, null, 2)
			}
			const parse = {
				custom: custom => {
					if (!custom) return undefined
					var obj = {}
					for (let value of custom.split('\n')) {
						if (!value.includes(':')) break
						value = value.split(':')
						obj[value[0].trim()] = value[1].trim()
					}
					return obj
				},
				filter: filter => {
					if (!filter) return undefined
					var obj = {}
					var type = getElement('#messenger-list-type').value
					obj[type] = filter.split('\n')
					obj[type === 'whitelist' ? 'blacklist' : 'whitelist'] = []
					return obj
				},
				link: links => {
					if (!links) return undefined
					var obj = {}
					for (let link of links.split('\n')) {
						if (!link.includes(':')) break
						link = link.split(':')
						obj[link[0].trim()] = link.length === 2 ? link[1].trim() : link.slice(1).map(v => v.trim())
					}
					return JSON.stringify(obj) === '{}' ? undefined : obj
				},
				sourceFormat: format => (format.discord || format.messenger) ? { discord: v(format.discord, ''),	messenger: v(format.messenger, '') } : undefined
			}
			const handle = {
				filter: list => {
					getElement('#messenger-list-type').value = list.whitelist.length > 0 ? 'whitelist' : 'blacklist'
					return (list.whitelist.length > 0 ? list.whitelist : list.blacklist).join('\n')
				},
				custom: custom => Object.entries(custom).map(el => el.join(':')).join('\n'),
				link: link => Object.entries(link).map(el => el.reduce((acc, val) => acc.concat(val), []).join(':')),
				sourceFormat: format => {
					form.messenger.sourceFormat.discord = format.discord
					form.messenger.sourceFormat.messenger = format.messenger
				}
			}
			function downloadData (data, name) {
				var ev = document.createEvent("MouseEvents")
				ev.initMouseEvent("click", true, false, self, 0, 0, 0, 0, 0, false, false, false, false, 0, null)
				var a = document.createElement('a')
				a.download = name
				a.href = 'data:application/octet-stream;base64,' + btoa(data)
				a.dispatchEvent(ev)
			}
		</script>
	</body>
</html>